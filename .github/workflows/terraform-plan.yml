name: Terraform plan workflow

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  TF_VERSION: 1.12.2
  TERRAFORM_STATE_ADDRESS: ${{ secrets.TERRAFORM_STATE_ADDRESS }}
  NETBOX_SERVER_URL: ${{ secrets.NETBOX_URL }}
  NETBOX_API_TOKEN: ${{ secrets.NETBOX_TOKEN }}
  TF_VAR_vm_user:  ${{ secrets.VM_USER }}
  TF_VAR_vm_ssh_keys:  ${{ secrets.VM_KEYS }}
  PM_API_URL: ${{ secrets.PM_API_URL }}
  PM_API_TOKEN_ID: ${{ secrets.PM_API_TOKEN_ID }}
  PM_API_TOKEN_SECRET: ${{ secrets.PM_API_TOKEN_SECRET }}

jobs:
  plan:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed dirs
        id: detect_changes
        run: |
          ALL_DIRS=$(find terraform/environments -mindepth 2 -maxdepth 2 -type d | sed 's|terraform/environments/||')

          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep '^terraform/environments/' | cut -d/ -f3,4 | sort -u)

          echo "$CHANGED_DIRS" > changed_dirs.txt

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Run terraform plan for each changed dir
        env:
          TERRAFORM_STATE_ADDRESS: ${{ secrets.TERRAFORM_STATE_ADDRESS }}
        run: |
          mkdir -p /plan_outputs

          for DIR in ${{ steps.detect_changes.outputs.changed_dirs }}; do
            echo "Planning $DIR"
            ENV_NAME=$(echo "$DIR" | cut -d'/' -f1)
            COMPONENT=$(echo "$DIR" | cut -d'/' -f2)

            WORKDIR="terraform/environments/$ENV_NAME/$COMPONENT"

            cd "$WORKDIR"

            terraform init -backend-config="address=${TERRAFORM_STATE_ADDRESS}"

            terraform plan -no-color -out=/plan_outputs/${ENV_NAME}_${COMPONENT}.out

            cd - >/dev/null
          done

      - name: Upload changed_dirs artifact
        uses: actions/upload-artifact@v4
        with:
          name: changed-dirs
          path: changed_dirs.txt

      - name: Upload terraform plans artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plans
          path: /plan_outputs/
