name: PR Docker Workflow

on:
  pull_request:
    paths:
      - 'docker/ci/**/**'
    branches:
      - main

jobs:
  get-dirs:
    uses: ./.github/workflows/get-dirs.yml
    with:
      base_dir: "docker"
      processing_mode: "changed"

  docker:
    if: ${{ needs.get-dirs.outputs.dirs != '[]' }}
    container:
      image:  "docker:28.3.3-dind-alpine3.22"
    needs: get-dirs
    runs-on: self-hosted
    strategy:
      matrix:
        image_dirs: ${{ fromJSON(needs.get-dirs.outputs.dirs) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build
        working-directory: "docker/${{ matrix.image_dirs }}"
        id: build
        run: |
          set -euo pipefail

          IMG_NAME="$(echo "${{ matrix.image_dirs }}" | tr '/' '-')"
          IMAGE="local/${IMG_NAME}"

          TAG="pr-${GITHUB_SHA::7}"

          echo "Building test image: ${IMAGE}:${TAG}"

          docker build \
            -t "${IMAGE}:${TAG}" \
            .
