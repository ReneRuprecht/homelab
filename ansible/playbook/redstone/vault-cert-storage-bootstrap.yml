---
- name: Bootstrap vault to read / write from secret
  hosts: localhost
  gather_facts: true
  vars:
    cert_path: "secret/data/certs/*"
  tasks:
    - name: Ensure vars exists and vault cli is working
      block:
        - name: Check cert_path
          ansible.builtin.assert:
            that:
              - cert_path is defined
              - cert_path != ""
            fail_msg: "cert_path var is empty"

        - name: Check vault login
          ansible.builtin.command:
            cmd: "vault login $VAULT_TOKEN"
          register: "assert_vault_token"
          ignore_errors: true
          changed_when: false
          no_log: true

        - name: Check vault cli output
          ansible.builtin.assert:
            that:
              - assert_vault_token.rc == 0
            fail_msg: "vault cli connection failed"

    - name: Ensure cert policies exist
      block:
        - name: Deploy cert-writer policy
          changed_when: false
          ansible.builtin.template:
            src: vault/cert-writer.hcl.j2
            dest: /tmp/cert-writer.hcl
            mode: "0644"

        - name: Apply cert-writer policy in Vault
          changed_when: false
          ansible.builtin.command:
            cmd: vault policy write cert-writer /tmp/cert-writer.hcl

        - name: Deploy cert-reader policy
          ansible.builtin.template:
            src: vault/cert-reader.hcl.j2
            dest: /tmp/cert-reader.hcl
            mode: "0644"

        - name: Apply cert-reader policy in Vault
          changed_when: false
          ansible.builtin.command:
            cmd: vault policy write cert-reader /tmp/cert-reader.hcl

        - name: Deploy cert-reader-writer policy
          ansible.builtin.template:
            src: vault/cert-reader-writer.hcl.j2
            dest: /tmp/cert-reader-writer.hcl
            mode: "0644"

        - name: Apply cert-reader-writer policy in Vault
          changed_when: false
          ansible.builtin.command:
            cmd: vault policy write cert-reader-writer /tmp/cert-reader-writer.hcl

        - name: Enable approle auth method
          ansible.builtin.command:
            cmd: vault auth enable approle
          register: approle_enable
          failed_when: approle_enable.rc != 0 and "path is already in use" not in approle_enable.stderr
          changed_when: approle_enable.rc == 0

        - name: Create approle for cert-writer
          changed_when: false
          ansible.builtin.command: >
            vault write auth/approle/role/cert-writer
            token_ttl=20m
            token_max_ttl=30m
            token_policies="cert-writer"

        - name: Create approle for cert-reader
          changed_when: false
          ansible.builtin.command: >
            vault write auth/approle/role/cert-reader
            token_ttl=20m
            token_max_ttl=30m
            token_policies="cert-reader"

        - name: Create approle for cert-reader-writer
          changed_when: false
          ansible.builtin.command: >
            vault write auth/approle/role/cert-reader-writer
            token_ttl=20m
            token_max_ttl=30m
            token_policies="cert-reader-writer"
